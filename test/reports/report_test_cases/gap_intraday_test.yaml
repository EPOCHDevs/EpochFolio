tests:
  - title: "Intraday Gap Analysis Test"
    input:
      type: "gap_report"
      # Both open and close bars for each day
      timestamps: [
        "2024-01-08T09:30:00",  # Monday open
        "2024-01-08T15:55:00",  # Monday close
        "2024-01-09T09:30:00",  # Tuesday open
        "2024-01-09T15:55:00",  # Tuesday close
        "2024-01-10T09:30:00",  # Wednesday open
        "2024-01-10T15:55:00"   # Wednesday close
      ]

      # Required inputs for gap_report
      # Gap analysis only applies to session opens
      gap_up: [
        true,   # Monday open: 101.5 > 100.0 (gap up)
        ~,      # Monday close: not a gap
        false,  # Tuesday open: 99.0 < 100.5 (gap down)
        ~,      # Tuesday close: not a gap
        true,   # Wednesday open: 100.0 > 98.6 (gap up)
        ~       # Wednesday close: not a gap
      ]

      gap_filled: [
        true,   # Monday: gap filled (price went below 100.0)
        ~,      # Monday close
        false,  # Tuesday: gap not filled (never reached 100.5)
        ~,      # Tuesday close
        false,  # Wednesday: gap not filled (partial fill only)
        ~       # Wednesday close
      ]

      fill_fraction: [
        1.0,    # Monday: fully filled
        ~,      # Monday close
        0.0,    # Tuesday: no fill
        ~,      # Tuesday close
        0.5,    # Wednesday: 50% fill
        ~       # Wednesday close
      ]

      gap_size: [
        1.5,    # Monday: 1.5% gap (as percentage)
        ~,      # Monday close
        1.49,   # Tuesday: 1.49% gap (as percentage, absolute value)
        ~,      # Tuesday close
        1.42,   # Wednesday: 1.42% gap (as percentage)
        ~       # Wednesday close
      ]

      psc: [
        100.0,  # Monday open: previous session close (Friday)
        ~,      # Monday close
        100.5,  # Tuesday open: Monday's close
        ~,      # Tuesday close
        98.6,   # Wednesday open: Tuesday's close
        ~       # Wednesday close
      ]

      psc_timestamp: [
        "2024-01-05T16:00:00",  # Friday close for Monday open
        ~,                      # Monday close
        "2024-01-08T16:00:00",  # Monday close for Tuesday open
        ~,                      # Tuesday close
        "2024-01-09T16:00:00",  # Tuesday close for Wednesday open
        ~                       # Wednesday close
      ]

      # Required data source - close prices for all bars
      c: [
        101.5,  # Monday open
        100.5,  # Monday close
        99.0,   # Tuesday open
        98.6,   # Tuesday close
        100.0,  # Wednesday open
        99.5    # Wednesday close
      ]

    expect:
      type: "tearsheet"
      cards:
        - data:
          - title: "Total Gaps"
            value: 3
        - data:
          - title: "Gap Up %"
            value: 66  # 2 gap ups out of 3
        - data:
          - title: "Gap Down %"
            value: 33  # 1 gap down out of 3
        - data:
          - title: "Fill Rate"
            value: 33  # 1 filled (Monday) out of 3

      charts:
        # Chart 1: Day of Week Bar Chart
        - type: "bar"
          title: "Gap Frequency by Day of Week"
          x_axis:
            type: "category"
            categories: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
          data:
            - name: "Gaps"
              values: [1, 1, 1, 0, 0, 0, 0]  # 1 gap each on Mon, Tue, Wed

        # Chart 2: Gap Size Distribution Histogram
        - type: "histogram"
          title: "Gap Size Distribution"
          bins: 10
          data:
            - name: "Gap Sizes"
              values: [1.5, 1.49, 1.42]  # The three gap sizes

        # Chart 3: Fill Time Pie Chart
        - type: "pie"
          title: "Gap Fill Time Distribution"
          data:
            - name: "before 13:00"
              value: 1  # Monday filled before 13:00
            - name: "not filled"
              value: 2  # Tuesday and Wednesday not filled

        # Chart 4: Trend Line Chart
        - type: "lines"
          title: "Gap Frequency Trend (Monthly)"
          data:
            - name: "Gap Frequency"
              points:
                - x: "2024-01"
                  y: 3  # All 3 gaps in January

      tables:
        # Table 1: Gap Up Fill Analysis
        - title: "Gap Up Fill Analysis"
          type: "table"
          columns:
            - name: "Category"
              type: "string"
            - name: "Count"
              type: "integer"
            - name: "Percentage"
              type: "percent"
          rows:
            - ["Filled", 1, 50.0]  # 1 out of 2 gap ups filled
            - ["Not Filled", 1, 50.0]  # 1 out of 2 gap ups not filled

        # Table 2: Gap Down Fill Analysis
        - title: "Gap Down Fill Analysis"
          type: "table"
          columns:
            - name: "Category"
              type: "string"
            - name: "Count"
              type: "integer"
            - name: "Percentage"
              type: "percent"
          rows:
            - ["Filled", 0, 0.0]  # 0 out of 1 gap down filled
            - ["Not Filled", 1, 100.0]  # 1 out of 1 gap down not filled

        # Table 3: Fill Time Frequency
        - title: "Gap Frequency by Time"
          type: "table"
          columns:
            - name: "Category"
              type: "string"
            - name: "Frequency"
              type: "integer"
            - name: "Percentage"
              type: "percent"
          rows:
            - ["09:30", 3, 100.0]  # All gaps at market open

        # Table 4: Performance Analysis
        - title: "Gap Fill vs Close Performance"
          type: "table"
          columns:
            - name: "Category"
              type: "string"
            - name: "Frequency"
              type: "integer"
            - name: "Percentage"
              type: "percent"
          rows:
            - ["green", 1, 33.33]  # Monday closed green (close > psc)
            - ["red", 2, 66.67]    # Tuesday and Wednesday closed red

        # Table 5: Comprehensive Gap Table (matches actual output)
        - title: "Comprehensive Gap Analysis"
          type: "table"
          columns:
            - name: "date"
              type: "date"
            - name: "gap size"
              type: "percent"
            - name: "gap category"
              type: "string"
            - name: "gap type"
              type: "string"
            - name: "gap filled"
              type: "string"
            - name: "weekday"
              type: "string"
            - name: "performance"
              type: "string"
            - name: "gap fill time"
              type: "string"
          rows:
            - ["2024-01-08", 1.50, "1.0-1.99%", "gap up", "filled", "Monday", "green", "before 13:00"]
            - ["2024-01-09", 1.49, "1.0-1.99%", "gap down", "not filled", "Tuesday", "red", "not filled"]
            - ["2024-01-10", 1.42, "1.0-1.99%", "gap up", "not filled", "Wednesday", "red", "not filled"]

    options:
      report_type: "gap_report"
      instance_id: "intraday_gap_test"
      show_fill_analysis: true
      show_day_of_week_analysis: true
      show_distribution_histogram: true
      show_comprehensive_table: true
      histogram_bins: 10